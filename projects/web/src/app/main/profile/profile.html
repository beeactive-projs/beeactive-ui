<p-toast />

<div class="mx-auto flex max-w-4xl flex-col gap-6 px-6 py-6 md:px-10 md:py-8">
  <!-- Header -->
  <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
    <div class="space-y-1">
      <p class="text-xs uppercase tracking-[0.2em] text-secondary-500">Account</p>
      <h1 class="font-heading text-2xl font-semibold text-secondary-900 md:text-3xl">My Profile</h1>
      <p class="text-sm text-secondary-500">View and manage your personal information and preferences.</p>
    </div>
    <div class="flex flex-wrap gap-2">
      @if (!loading()) {
        <p-button
          label="Edit Profile"
          icon="pi pi-pencil"
          severity="primary"
          styleClass="!rounded-full"
          (onClick)="openEditDialog()"
        />
      }
    </div>
  </header>

  @if (loading()) {
    <!-- Loading Skeleton -->
    <p-card styleClass="shadow-sm">
      <div class="flex flex-col items-center gap-4 sm:flex-row sm:items-start">
        <p-skeleton shape="circle" size="5rem" />
        <div class="flex flex-1 flex-col gap-3">
          <p-skeleton width="12rem" height="1.5rem" />
          <p-skeleton width="16rem" height="1rem" />
          <div class="flex gap-2">
            <p-skeleton width="4rem" height="1.5rem" />
            <p-skeleton width="4rem" height="1.5rem" />
          </div>
        </div>
      </div>
    </p-card>
    <p-card styleClass="shadow-sm">
      <div class="grid gap-4 sm:grid-cols-2">
        @for (_ of [1, 2, 3, 4, 5, 6]; track _) {
          <div class="flex flex-col gap-2">
            <p-skeleton width="5rem" height="0.75rem" />
            <p-skeleton width="10rem" height="1rem" />
          </div>
        }
      </div>
    </p-card>
  } @else if (profile(); as p) {
    <!-- User Identity Card -->
    <p-card styleClass="shadow-sm">
      <div class="flex flex-col items-center gap-4 sm:flex-row sm:items-start">
        <p-avatar [label]="initials()" shape="circle" size="xlarge" styleClass="text-2xl bg-primary-100 text-primary-700" />
        <div class="flex flex-1 flex-col gap-1 text-center sm:text-left">
          <h2 class="text-xl font-semibold text-secondary-900">{{ fullName() }}</h2>
          <p class="text-sm text-secondary-500">{{ p.user.email }}</p>
          @if (p.user.phone) {
            <p class="text-sm text-secondary-500">{{ p.user.phone }}</p>
          }
          <div class="mt-2 flex flex-wrap justify-center gap-2 sm:justify-start">
            @for (role of p.roles; track role) {
              <p-tag [value]="role" [severity]="roleSeverity(role)" styleClass="!text-xs" />
            }
            @if (p.user.isEmailVerified) {
              <p-tag value="Verified" severity="success" icon="pi pi-check" styleClass="!text-xs" />
            } @else {
              <p-tag value="Unverified" severity="warn" icon="pi pi-exclamation-triangle" styleClass="!text-xs" />
            }
          </div>
          <p class="mt-1 text-xs text-secondary-400">Member since {{ p.user.createdAt | date: 'mediumDate' }}</p>
        </div>
      </div>
    </p-card>

    <!-- Personal Details Card -->
    <p-card styleClass="shadow-sm">
      <div class="flex items-center gap-2 mb-4">
        <i class="pi pi-user text-lg text-primary-600"></i>
        <h3 class="text-lg font-semibold text-secondary-900">Personal Information</h3>
      </div>
      <dl class="grid gap-4 sm:grid-cols-2">
        <div>
          <dt class="text-xs uppercase tracking-wide text-secondary-500">First Name</dt>
          <dd class="mt-1 text-sm font-medium text-secondary-900">{{ p.user.firstName }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-secondary-500">Last Name</dt>
          <dd class="mt-1 text-sm font-medium text-secondary-900">{{ p.user.lastName }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-secondary-500">Email</dt>
          <dd class="mt-1 text-sm font-medium text-secondary-900">{{ p.user.email }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-secondary-500">Phone</dt>
          <dd class="mt-1 text-sm font-medium text-secondary-900">{{ p.user.phone || 'Not provided' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-secondary-500">Account Status</dt>
          <dd class="mt-1">
            <p-tag
              [value]="p.user.isActive ? 'Active' : 'Inactive'"
              [severity]="p.user.isActive ? 'success' : 'danger'"
              styleClass="!text-xs"
            />
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-secondary-500">Member Since</dt>
          <dd class="mt-1 text-sm font-medium text-secondary-900">{{ p.user.createdAt | date: 'mediumDate' }}</dd>
        </div>
      </dl>
    </p-card>

    <!-- Fitness Profile Card -->
    <p-card styleClass="shadow-sm">
      <div class="flex items-center gap-2 mb-4">
        <i class="pi pi-heart text-lg text-primary-600"></i>
        <h3 class="text-lg font-semibold text-secondary-900">Fitness Profile</h3>
      </div>
      @if (p.userProfile) {
        <dl class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          <div>
            <dt class="text-xs uppercase tracking-wide text-secondary-500">Date of Birth</dt>
            <dd class="mt-1 text-sm font-medium text-secondary-900">
              {{ p.userProfile.dateOfBirth ? (p.userProfile.dateOfBirth | date: 'mediumDate') : 'Not set' }}
            </dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-secondary-500">Gender</dt>
            <dd class="mt-1 text-sm font-medium text-secondary-900">{{ formattedGender() || 'Not set' }}</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-secondary-500">Fitness Level</dt>
            <dd class="mt-1">
              @if (formattedFitnessLevel()) {
                <p-tag [value]="formattedFitnessLevel()!" severity="info" styleClass="!text-xs" />
              } @else {
                <span class="text-sm font-medium text-secondary-900">Not set</span>
              }
            </dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-secondary-500">Height</dt>
            <dd class="mt-1 text-sm font-medium text-secondary-900">
              {{ p.userProfile.heightCm ? p.userProfile.heightCm + ' cm' : 'Not set' }}
            </dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-secondary-500">Weight</dt>
            <dd class="mt-1 text-sm font-medium text-secondary-900">
              {{ p.userProfile.weightKg ? p.userProfile.weightKg + ' kg' : 'Not set' }}
            </dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-secondary-500">Goals</dt>
            <dd class="mt-1">
              @if (p.userProfile.goals?.length) {
                <div class="flex flex-wrap gap-1">
                  @for (goal of p.userProfile.goals; track goal) {
                    <p-tag [value]="goal" severity="secondary" styleClass="!text-xs" />
                  }
                </div>
              } @else {
                <span class="text-sm font-medium text-secondary-900">Not set</span>
              }
            </dd>
          </div>
        </dl>

        <p-divider />

        <h4 class="text-sm font-semibold text-secondary-700 mb-3">Emergency Contact</h4>
        <dl class="grid gap-4 sm:grid-cols-2">
          <div>
            <dt class="text-xs uppercase tracking-wide text-secondary-500">Contact Name</dt>
            <dd class="mt-1 text-sm font-medium text-secondary-900">
              {{ p.userProfile.emergencyContactName || 'Not provided' }}
            </dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-secondary-500">Contact Phone</dt>
            <dd class="mt-1 text-sm font-medium text-secondary-900">
              {{ p.userProfile.emergencyContactPhone || 'Not provided' }}
            </dd>
          </div>
        </dl>
      } @else {
        <div class="flex flex-col items-center gap-3 py-6 text-center">
          <i class="pi pi-heart text-3xl text-secondary-300"></i>
          <p class="text-sm text-secondary-500">No fitness profile data yet. Edit your profile to add your fitness details.</p>
        </div>
      }
    </p-card>

    <!-- Instructor Profile Card (only for instructors/organizers) -->
    @if (isInstructor() && hasInstructorProfile()) {
      <p-card styleClass="shadow-sm">
        <div class="flex items-center gap-2 mb-4">
          <i class="pi pi-star text-lg text-primary-600"></i>
          <h3 class="text-lg font-semibold text-secondary-900">Instructor Profile</h3>
          @if (p.instructorProfile?.isAcceptingClients) {
            <p-tag value="Accepting Clients" severity="success" icon="pi pi-check" styleClass="!text-xs ml-auto" />
          } @else {
            <p-tag value="Not Accepting" severity="secondary" styleClass="!text-xs ml-auto" />
          }
        </div>
        @if (p.instructorProfile; as ip) {
          <dl class="grid gap-4 sm:grid-cols-2">
            <div>
              <dt class="text-xs uppercase tracking-wide text-secondary-500">Display Name</dt>
              <dd class="mt-1 text-sm font-medium text-secondary-900">{{ ip.displayName || 'Not set' }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-secondary-500">Years of Experience</dt>
              <dd class="mt-1 text-sm font-medium text-secondary-900">
                {{ ip.yearsOfExperience != null ? ip.yearsOfExperience + ' years' : 'Not set' }}
              </dd>
            </div>
            <div class="sm:col-span-2">
              <dt class="text-xs uppercase tracking-wide text-secondary-500">Bio</dt>
              <dd class="mt-1 text-sm font-medium text-secondary-900 whitespace-pre-line">
                {{ ip.bio || 'No bio added yet.' }}
              </dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-secondary-500">Location</dt>
              <dd class="mt-1 text-sm font-medium text-secondary-900">
                @if (ip.locationCity || ip.locationCountry) {
                  {{ ip.locationCity }}{{ ip.locationCity && ip.locationCountry ? ', ' : '' }}{{ ip.locationCountry }}
                } @else {
                  Not set
                }
              </dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-secondary-500">Specializations</dt>
              <dd class="mt-1">
                @if (ip.specializations?.length) {
                  <div class="flex flex-wrap gap-1">
                    @for (spec of ip.specializations; track spec) {
                      <p-tag [value]="spec" severity="info" styleClass="!text-xs" />
                    }
                  </div>
                } @else {
                  <span class="text-sm font-medium text-secondary-900">Not set</span>
                }
              </dd>
            </div>
            @if (ip.certifications?.length) {
              <div class="sm:col-span-2">
                <dt class="text-xs uppercase tracking-wide text-secondary-500 mb-2">Certifications</dt>
                <dd>
                  <div class="flex flex-wrap gap-2">
                    @for (cert of ip.certifications; track cert.name) {
                      <div class="rounded-lg bg-surface-50 px-3 py-2">
                        <span class="text-sm font-medium text-secondary-900">{{ cert.name }}</span>
                        <span class="text-xs text-secondary-500"> - {{ cert.issuer }} ({{ cert.year }})</span>
                      </div>
                    }
                  </div>
                </dd>
              </div>
            }
          </dl>
        }
      </p-card>
    }
  } @else {
    <!-- No Profile Fallback -->
    <p-card styleClass="shadow-sm">
      <div class="flex flex-col items-center gap-3 py-12 text-center">
        <i class="pi pi-user text-4xl text-secondary-300"></i>
        <h2 class="text-lg font-semibold text-secondary-700">No profile data available</h2>
        <p class="text-sm text-secondary-500">We couldn't load your profile. Please try again later.</p>
        <p-button
          label="Retry"
          icon="pi pi-refresh"
          severity="primary"
          styleClass="!rounded-full mt-2"
          (onClick)="loadProfile()"
        />
      </div>
    </p-card>
  }
</div>

<!-- Edit Profile Dialog -->
<p-dialog
  header="Edit Profile"
  [visible]="showEditDialog()"
  (visibleChange)="showEditDialog.set($event)"
  [modal]="true"
  [style]="{ width: '40rem' }"
  [closable]="true"
  [maximizable]="true"
>
  <p-tabs [value]="activeTab()" (valueChange)="activeTab.set(+($event ?? 0))">
    <p-tablist>
      <p-tab [value]="0">
        <i class="pi pi-user mr-2"></i>
        Personal Info
      </p-tab>
      <p-tab [value]="1">
        <i class="pi pi-heart mr-2"></i>
        Fitness Profile
      </p-tab>
      @if (isInstructor() && hasInstructorProfile()) {
        <p-tab [value]="2">
          <i class="pi pi-star mr-2"></i>
          Instructor
        </p-tab>
      }
    </p-tablist>

    <p-tabpanels>
      <!-- Personal Info Tab -->
      <p-tabpanel [value]="0">
        <div class="flex flex-col gap-4 pt-4">
          <div class="grid gap-4 sm:grid-cols-2">
            <div class="flex flex-col gap-2">
              <label for="editFirstName" class="text-sm font-medium text-secondary-700">First Name</label>
              <input
                id="editFirstName"
                type="text"
                pInputText
                [ngModel]="editForm().firstName"
                (ngModelChange)="updateFormField('firstName', $event)"
                placeholder="First name"
              />
            </div>
            <div class="flex flex-col gap-2">
              <label for="editLastName" class="text-sm font-medium text-secondary-700">Last Name</label>
              <input
                id="editLastName"
                type="text"
                pInputText
                [ngModel]="editForm().lastName"
                (ngModelChange)="updateFormField('lastName', $event)"
                placeholder="Last name"
              />
            </div>
          </div>
          <div class="flex flex-col gap-2">
            <label for="editPhone" class="text-sm font-medium text-secondary-700">Phone Number</label>
            <input
              id="editPhone"
              type="tel"
              pInputText
              [ngModel]="editForm().phone"
              (ngModelChange)="updateFormField('phone', $event)"
              placeholder="e.g. +1 234 567 8900"
            />
          </div>
        </div>
      </p-tabpanel>

      <!-- Fitness Profile Tab -->
      <p-tabpanel [value]="1">
        <div class="flex flex-col gap-4 pt-4">
          <div class="grid gap-4 sm:grid-cols-2">
            <div class="flex flex-col gap-2">
              <label for="editDob" class="text-sm font-medium text-secondary-700">Date of Birth</label>
              <input
                id="editDob"
                type="date"
                pInputText
                [ngModel]="editForm().dateOfBirth"
                (ngModelChange)="updateFormField('dateOfBirth', $event)"
              />
            </div>
            <div class="flex flex-col gap-2">
              <label for="editGender" class="text-sm font-medium text-secondary-700">Gender</label>
              <p-select
                id="editGender"
                [options]="genderOptions"
                [ngModel]="editForm().gender"
                (ngModelChange)="updateFormField('gender', $event)"
                optionLabel="label"
                optionValue="value"
                placeholder="Select gender"
                [showClear]="true"
                styleClass="w-full"
              />
            </div>
          </div>
          <div class="grid gap-4 sm:grid-cols-3">
            <div class="flex flex-col gap-2">
              <label for="editHeight" class="text-sm font-medium text-secondary-700">Height (cm)</label>
              <input
                id="editHeight"
                type="number"
                pInputText
                [ngModel]="editForm().heightCm"
                (ngModelChange)="updateFormField('heightCm', $event)"
                placeholder="e.g. 175"
              />
            </div>
            <div class="flex flex-col gap-2">
              <label for="editWeight" class="text-sm font-medium text-secondary-700">Weight (kg)</label>
              <input
                id="editWeight"
                type="number"
                pInputText
                [ngModel]="editForm().weightKg"
                (ngModelChange)="updateFormField('weightKg', $event)"
                placeholder="e.g. 70"
              />
            </div>
            <div class="flex flex-col gap-2">
              <label for="editFitness" class="text-sm font-medium text-secondary-700">Fitness Level</label>
              <p-select
                id="editFitness"
                [options]="fitnessOptions"
                [ngModel]="editForm().fitnessLevel"
                (ngModelChange)="updateFormField('fitnessLevel', $event)"
                optionLabel="label"
                optionValue="value"
                placeholder="Select level"
                [showClear]="true"
                styleClass="w-full"
              />
            </div>
          </div>
          <div class="flex flex-col gap-2">
            <label for="editGoals" class="text-sm font-medium text-secondary-700">Goals</label>
            <input
              id="editGoals"
              type="text"
              pInputText
              [ngModel]="editForm().goals"
              (ngModelChange)="updateFormField('goals', $event)"
              placeholder="Separate with commas, e.g. Lose weight, Build muscle"
            />
            <span class="text-xs text-secondary-400">Separate multiple goals with commas</span>
          </div>

          <p-divider />

          <h4 class="text-sm font-semibold text-secondary-700">Emergency Contact</h4>
          <div class="grid gap-4 sm:grid-cols-2">
            <div class="flex flex-col gap-2">
              <label for="editEmName" class="text-sm font-medium text-secondary-700">Contact Name</label>
              <input
                id="editEmName"
                type="text"
                pInputText
                [ngModel]="editForm().emergencyContactName"
                (ngModelChange)="updateFormField('emergencyContactName', $event)"
                placeholder="Full name"
              />
            </div>
            <div class="flex flex-col gap-2">
              <label for="editEmPhone" class="text-sm font-medium text-secondary-700">Contact Phone</label>
              <input
                id="editEmPhone"
                type="tel"
                pInputText
                [ngModel]="editForm().emergencyContactPhone"
                (ngModelChange)="updateFormField('emergencyContactPhone', $event)"
                placeholder="Phone number"
              />
            </div>
          </div>
        </div>
      </p-tabpanel>

      <!-- Instructor Profile Tab -->
      @if (isInstructor() && hasInstructorProfile()) {
        <p-tabpanel [value]="2">
          <div class="flex flex-col gap-4 pt-4">
            <div class="flex flex-col gap-2">
              <label for="editDisplayName" class="text-sm font-medium text-secondary-700">Display Name</label>
              <input
                id="editDisplayName"
                type="text"
                pInputText
                [ngModel]="editForm().displayName"
                (ngModelChange)="updateFormField('displayName', $event)"
                placeholder="Name shown to clients"
              />
            </div>
            <div class="flex flex-col gap-2">
              <label for="editBio" class="text-sm font-medium text-secondary-700">Bio</label>
              <textarea
                id="editBio"
                pTextarea
                [ngModel]="editForm().bio"
                (ngModelChange)="updateFormField('bio', $event)"
                [rows]="4"
                placeholder="Tell clients about yourself, your experience, and training style..."
              ></textarea>
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
              <div class="flex flex-col gap-2">
                <label for="editSpecializations" class="text-sm font-medium text-secondary-700">Specializations</label>
                <input
                  id="editSpecializations"
                  type="text"
                  pInputText
                  [ngModel]="editForm().specializations"
                  (ngModelChange)="updateFormField('specializations', $event)"
                  placeholder="e.g. Yoga, HIIT, Pilates"
                />
                <span class="text-xs text-secondary-400">Separate with commas</span>
              </div>
              <div class="flex flex-col gap-2">
                <label for="editYears" class="text-sm font-medium text-secondary-700">Years of Experience</label>
                <input
                  id="editYears"
                  type="number"
                  pInputText
                  [ngModel]="editForm().yearsOfExperience"
                  (ngModelChange)="updateFormField('yearsOfExperience', $event)"
                  placeholder="e.g. 5"
                />
              </div>
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
              <div class="flex flex-col gap-2">
                <label for="editCity" class="text-sm font-medium text-secondary-700">City</label>
                <input
                  id="editCity"
                  type="text"
                  pInputText
                  [ngModel]="editForm().locationCity"
                  (ngModelChange)="updateFormField('locationCity', $event)"
                  placeholder="e.g. New York"
                />
              </div>
              <div class="flex flex-col gap-2">
                <label for="editCountry" class="text-sm font-medium text-secondary-700">Country</label>
                <input
                  id="editCountry"
                  type="text"
                  pInputText
                  [ngModel]="editForm().locationCountry"
                  (ngModelChange)="updateFormField('locationCountry', $event)"
                  placeholder="e.g. United States"
                />
              </div>
            </div>
            <div class="flex items-center gap-3 rounded-lg bg-surface-50 p-4">
              <p-toggleSwitch
                [ngModel]="editForm().isAcceptingClients"
                (ngModelChange)="updateFormField('isAcceptingClients', $event)"
              />
              <div>
                <span class="text-sm font-medium text-secondary-900">Accepting New Clients</span>
                <p class="text-xs text-secondary-500">Allow clients to send you requests</p>
              </div>
            </div>
          </div>
        </p-tabpanel>
      }
    </p-tabpanels>
  </p-tabs>

  <ng-template #footer>
    <p-button label="Cancel" severity="secondary" [text]="true" (onClick)="showEditDialog.set(false)" />
    <p-button
      label="Save Changes"
      icon="pi pi-check"
      severity="primary"
      [loading]="saving()"
      (onClick)="saveProfile()"
    />
  </ng-template>
</p-dialog>
