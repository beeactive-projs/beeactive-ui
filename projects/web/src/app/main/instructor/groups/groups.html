<p-toast />
<p-confirmDialog />

<div class="mx-auto flex max-w-7xl flex-col gap-6 px-6 py-6 md:px-10 md:py-8">
  <!-- Header -->
  <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
    <div class="space-y-1">
      <p class="text-xs uppercase tracking-[0.2em] text-secondary-500">Group Management</p>
      <h1 class="font-heading text-2xl font-semibold text-secondary-900 md:text-3xl">Groups</h1>
      <p class="text-sm text-secondary-500">Organize your clients into groups for sessions and communication.</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <p-button
        label="Create Group"
        icon="pi pi-plus"
        severity="primary"
        styleClass="!rounded-full"
        (onClick)="openCreateDialog()"
      />
    </div>
  </header>

  <!-- Loading State -->
  @if (loading()) {
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
      @for (i of [1, 2, 3]; track i) {
        <p-card styleClass="shadow-sm">
          <div class="flex animate-pulse flex-col gap-3">
            <div class="h-5 w-2/3 rounded bg-surface-200"></div>
            <div class="h-4 w-1/3 rounded bg-surface-200"></div>
            <div class="h-10 w-full rounded bg-surface-200"></div>
            <div class="flex gap-2">
              <div class="h-6 w-16 rounded-full bg-surface-200"></div>
              <div class="h-6 w-12 rounded-full bg-surface-200"></div>
            </div>
          </div>
        </p-card>
      }
    </div>
  }

  <!-- Empty State -->
  @if (!loading() && groups().length === 0) {
    <div class="flex flex-col items-center gap-4 py-16 text-center">
      <div class="flex h-20 w-20 items-center justify-center rounded-full bg-surface-200">
        <i class="pi pi-sitemap text-4xl text-secondary-300"></i>
      </div>
      <h2 class="text-lg font-semibold text-secondary-700">No groups yet</h2>
      <p class="max-w-sm text-sm text-secondary-500">
        Create your first group to start organizing clients and scheduling sessions.
      </p>
      <p-button
        label="Create Your First Group"
        icon="pi pi-plus"
        severity="primary"
        styleClass="!rounded-full mt-2"
        (onClick)="openCreateDialog()"
      />
    </div>
  }

  <!-- Groups Grid -->
  @if (!loading() && groups().length > 0) {
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
      @for (group of groups(); track trackById($index, group)) {
        <p-card
          styleClass="shadow-sm cursor-pointer hover:shadow-md transition-shadow"
          (click)="navigateToGroup(group)"
        >
          <div class="flex flex-col gap-3">
            <!-- Card Header -->
            <div class="flex items-start justify-between">
              <div class="min-w-0 flex-1">
                <h3 class="truncate text-base font-semibold text-secondary-900">{{ group.name }}</h3>
              </div>
              <div class="ml-2 flex shrink-0 gap-1">
                <p-button
                  icon="pi pi-pencil"
                  [rounded]="true"
                  [text]="true"
                  severity="secondary"
                  size="small"
                  (onClick)="openEditDialog($event, group)"
                />
                <p-button
                  icon="pi pi-trash"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  size="small"
                  (onClick)="confirmDelete($event, group)"
                />
              </div>
            </div>

            <!-- Member Count & Join Policy -->
            <div class="flex items-center gap-2">
              <span class="flex items-center gap-1 text-sm text-secondary-500">
                <i class="pi pi-users text-xs"></i>
                {{ group.memberCount }} {{ group.memberCount === 1 ? 'member' : 'members' }}
              </span>
              <p-tag
                [value]="joinPolicyLabel(group.joinPolicy)"
                [severity]="joinPolicySeverity(group.joinPolicy)"
                styleClass="!text-xs"
              />
              @if (!group.isPublic) {
                <p-tag value="Private" severity="secondary" styleClass="!text-xs" />
              }
            </div>

            <!-- Description -->
            <p class="text-sm text-secondary-500 line-clamp-2">
              {{ descriptionExcerpt(group.description) }}
            </p>

            <!-- Tags -->
            @if (group.tags && group.tags.length > 0) {
              <div class="flex flex-wrap gap-1">
                @for (tag of group.tags; track tag) {
                  <p-tag [value]="tag" severity="contrast" styleClass="!text-xs" />
                }
              </div>
            }
          </div>
        </p-card>
      }
    </div>
  }
</div>

<!-- Create/Edit Dialog -->
<p-dialog
  [header]="dialogHeader()"
  [visible]="showDialog()"
  (visibleChange)="showDialog.set($event)"
  [modal]="true"
  [style]="{ width: '32rem' }"
  [closable]="true"
>
  <div class="flex flex-col gap-4">
    <!-- Name -->
    <div class="flex flex-col gap-2">
      <label for="groupName" class="text-sm font-medium text-secondary-700">Name *</label>
      <input
        id="groupName"
        type="text"
        pInputText
        [(ngModel)]="formName"
        placeholder="Enter group name"
      />
    </div>

    <!-- Description -->
    <div class="flex flex-col gap-2">
      <label for="groupDescription" class="text-sm font-medium text-secondary-700">Description</label>
      <textarea
        id="groupDescription"
        pTextarea
        [(ngModel)]="formDescription"
        [rows]="3"
        placeholder="Describe the purpose of this group..."
      ></textarea>
    </div>

    <!-- Join Policy -->
    <div class="flex flex-col gap-2">
      <label for="joinPolicy" class="text-sm font-medium text-secondary-700">Join Policy</label>
      <p-select
        id="joinPolicy"
        [options]="joinPolicyOptions"
        [(ngModel)]="formJoinPolicy"
        optionLabel="label"
        optionValue="value"
        placeholder="Select join policy"
        styleClass="w-full"
      />
    </div>

    <!-- Public Toggle -->
    <div class="flex items-center justify-between rounded-lg bg-surface-50 p-3">
      <div>
        <span class="text-sm font-medium text-secondary-700">Public Group</span>
        <p class="text-xs text-secondary-500">Visible in group discovery</p>
      </div>
      <p-toggleSwitch [(ngModel)]="formIsPublic" />
    </div>

    <!-- Tags -->
    <div class="flex flex-col gap-2">
      <label class="text-sm font-medium text-secondary-700">Tags</label>
      <div class="flex gap-2">
        <input
          type="text"
          pInputText
          [(ngModel)]="formTagInput"
          placeholder="Add a tag and press Enter"
          class="flex-1"
          (keydown)="onTagKeydown($event)"
        />
        <p-button
          icon="pi pi-plus"
          severity="secondary"
          [disabled]="!formTagInput.trim()"
          (onClick)="addTag()"
        />
      </div>
      @if (formTags.length > 0) {
        <div class="flex flex-wrap gap-1">
          @for (tag of formTags; track tag) {
            <p-chip [label]="tag" [removable]="true" (onRemove)="removeTag(tag)" />
          }
        </div>
      }
    </div>
  </div>

  <ng-template #footer>
    <p-button label="Cancel" severity="secondary" [text]="true" (onClick)="showDialog.set(false)" />
    <p-button
      [label]="dialogMode() === 'create' ? 'Create Group' : 'Save Changes'"
      icon="pi pi-check"
      severity="primary"
      [loading]="saving()"
      [disabled]="!formName.trim()"
      (onClick)="saveGroup()"
    />
  </ng-template>
</p-dialog>
