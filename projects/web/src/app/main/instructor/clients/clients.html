<p-toast />
<p-confirmDialog />

<div class="mx-auto flex max-w-7xl flex-col gap-6 px-6 py-6 md:px-10 md:py-8">
  <!-- Header -->
  <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
    <div class="space-y-1">
      <p class="text-xs uppercase tracking-[0.2em] text-secondary-500">Client Management</p>
      <h1 class="font-heading text-2xl font-semibold text-secondary-900 md:text-3xl">Clients</h1>
      <p class="text-sm text-secondary-500">Manage your client relationships, invitations, and requests.</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <p-button
        label="Invite Client"
        icon="pi pi-user-plus"
        severity="primary"
        styleClass="!rounded-full"
        (onClick)="openInviteDialog()"
      />
    </div>
  </header>

  <!-- Pending Requests Banner -->
  @if (pendingCount() > 0) {
    <p-card styleClass="shadow-sm border-l-4 border-l-yellow-400">
      <div class="flex flex-col gap-3">
        <div class="flex items-center gap-2">
          <i class="pi pi-bell text-yellow-600"></i>
          <h3 class="text-base font-semibold text-secondary-900">
            Pending Requests ({{ pendingCount() }})
          </h3>
        </div>
        <div class="space-y-3">
          @for (request of pendingRequests(); track trackById($index, request)) {
            <div class="flex items-center justify-between rounded-lg bg-surface-50 p-3">
              <div class="flex items-center gap-3">
                <p-avatar
                  [label]="request.fromUser ? request.fromUser.firstName.charAt(0) + request.fromUser.lastName.charAt(0) : '??'"
                  shape="circle"
                  styleClass="bg-yellow-100 text-yellow-700"
                />
                <div>
                  <span class="font-medium text-secondary-900">{{ requestFromName(request) }}</span>
                  <span class="text-sm text-secondary-500"> wants to become your client</span>
                  @if (request.message) {
                    <p class="mt-1 text-xs text-secondary-500 italic">"{{ request.message }}"</p>
                  }
                </div>
              </div>
              <div class="flex gap-2">
                <p-button
                  icon="pi pi-check"
                  severity="success"
                  [rounded]="true"
                  [text]="true"
                  pTooltip="Accept"
                  (onClick)="acceptPendingRequest(request)"
                />
                <p-button
                  icon="pi pi-times"
                  severity="danger"
                  [rounded]="true"
                  [text]="true"
                  pTooltip="Decline"
                  (onClick)="declinePendingRequest(request)"
                />
              </div>
            </div>
          }
        </div>
      </div>
    </p-card>
  }

  <!-- Filters -->
  <div class="flex items-center gap-3">
    <span class="text-sm font-medium text-secondary-600">Status:</span>
    @for (option of statusOptions; track option.label) {
      <p-button
        [label]="option.label"
        [severity]="statusFilter() === option.value ? 'primary' : 'secondary'"
        [text]="statusFilter() !== option.value"
        size="small"
        styleClass="!rounded-full"
        (onClick)="onStatusFilterChange(option.value)"
      />
    }
  </div>

  <!-- Clients Table -->
  <p-table
    [value]="clients()"
    [lazy]="true"
    [paginator]="true"
    [rows]="rows"
    [totalRecords]="totalRecords()"
    [loading]="loading()"
    [rowsPerPageOptions]="[10, 20, 50]"
    (onLazyLoad)="onPageChange($event)"
    [scrollable]="true"
    scrollHeight="flex"
    dataKey="id"
  >
    <ng-template #header>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Status</th>
        <th>Started</th>
        <th>Groups</th>
        <th>Notes</th>
        <th class="w-32 text-center">Actions</th>
      </tr>
    </ng-template>

    <ng-template #body let-client>
      <tr>
        <td>
          <div class="flex items-center gap-3">
            <p-avatar [label]="initials(client)" shape="circle" styleClass="bg-primary-100 text-primary-700" />
            <span class="font-medium text-secondary-900">{{ clientName(client) }}</span>
          </div>
        </td>
        <td>{{ client.client?.email || '—' }}</td>
        <td>
          <p-tag [value]="client.status" [severity]="statusSeverity(client.status)" />
        </td>
        <td>{{ client.startedAt ? (client.startedAt | date: 'mediumDate') : '—' }}</td>
        <td>
          @if (client.groupMemberships?.length) {
            <div class="flex flex-wrap gap-1">
              @for (group of client.groupMemberships; track group.groupId) {
                <p-tag [value]="group.groupName" severity="info" styleClass="!text-xs" />
              }
            </div>
          } @else {
            <span class="text-secondary-400">—</span>
          }
        </td>
        <td>
          @if (client.notes) {
            <span class="text-xs text-secondary-500 truncate max-w-[120px] inline-block" [pTooltip]="client.notes">
              {{ client.notes }}
            </span>
          } @else {
            <span class="text-secondary-400">—</span>
          }
        </td>
        <td>
          <div class="flex items-center justify-center gap-1">
            <p-button
              icon="pi pi-pencil"
              [rounded]="true"
              [text]="true"
              severity="secondary"
              pTooltip="Edit Notes"
              (onClick)="openNotesDialog(client)"
            />
            @if (client.status === 'ACTIVE') {
              <p-button
                icon="pi pi-inbox"
                [rounded]="true"
                [text]="true"
                severity="danger"
                pTooltip="Archive"
                (onClick)="confirmArchive(client)"
              />
            }
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template #loadingbody>
      <tr>
        <td>
          <div class="flex items-center gap-3">
            <p-skeleton shape="circle" size="2rem" />
            <p-skeleton width="8rem" />
          </div>
        </td>
        <td><p-skeleton width="12rem" /></td>
        <td><p-skeleton width="4rem" /></td>
        <td><p-skeleton width="6rem" /></td>
        <td><p-skeleton width="5rem" /></td>
        <td><p-skeleton width="6rem" /></td>
        <td><p-skeleton width="4rem" /></td>
      </tr>
    </ng-template>

    <ng-template #emptymessage>
      <tr>
        <td colspan="7">
          <div class="flex flex-col items-center gap-3 py-12 text-center">
            <i class="pi pi-users text-4xl text-secondary-300"></i>
            <h2 class="text-lg font-semibold text-secondary-700">No clients yet</h2>
            <p class="text-sm text-secondary-500">
              Start by inviting clients to build your client base.
            </p>
            <p-button
              label="Invite Your First Client"
              icon="pi pi-user-plus"
              severity="primary"
              styleClass="!rounded-full mt-2"
              (onClick)="openInviteDialog()"
            />
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Invite Dialog -->
<p-dialog
  header="Invite Client"
  [visible]="showInviteDialog()"
  (visibleChange)="showInviteDialog.set($event)"
  [modal]="true"
  [style]="{ width: '28rem' }"
  [closable]="true"
>
  <div class="flex flex-col gap-4">
    <div class="flex flex-col gap-2">
      <label for="inviteEmail" class="text-sm font-medium text-secondary-700">Email Address</label>
      <input
        id="inviteEmail"
        type="email"
        pInputText
        [(ngModel)]="inviteEmail"
        placeholder="Enter the client's email address"
      />
      <span class="text-xs text-secondary-400">The client will receive an email invitation</span>
    </div>
    <div class="flex flex-col gap-2">
      <label for="inviteMessage" class="text-sm font-medium text-secondary-700">Message (optional)</label>
      <textarea
        id="inviteMessage"
        pTextarea
        [(ngModel)]="inviteMessage"
        [rows]="3"
        placeholder="Add a personal message..."
      ></textarea>
    </div>
  </div>
  <ng-template #footer>
    <p-button label="Cancel" severity="secondary" [text]="true" (onClick)="showInviteDialog.set(false)" />
    <p-button
      label="Send Invitation"
      icon="pi pi-send"
      severity="primary"
      [loading]="inviteLoading()"
      [disabled]="!inviteEmail.trim()"
      (onClick)="sendInvitation()"
    />
  </ng-template>
</p-dialog>

<!-- Notes Dialog -->
<p-dialog
  header="Edit Client Notes"
  [visible]="showNotesDialog()"
  (visibleChange)="showNotesDialog.set($event)"
  [modal]="true"
  [style]="{ width: '28rem' }"
  [closable]="true"
>
  <div class="flex flex-col gap-4">
    @if (editingClient(); as client) {
      <div class="flex items-center gap-3 rounded-lg bg-surface-50 p-3">
        <p-avatar [label]="initials(client)" shape="circle" styleClass="bg-primary-100 text-primary-700" />
        <span class="font-medium text-secondary-900">{{ clientName(client) }}</span>
      </div>
    }
    <div class="flex flex-col gap-2">
      <label for="editNotes" class="text-sm font-medium text-secondary-700">Notes</label>
      <textarea
        id="editNotes"
        pTextarea
        [(ngModel)]="editNotes"
        [rows]="5"
        placeholder="Add private notes about this client..."
      ></textarea>
    </div>
  </div>
  <ng-template #footer>
    <p-button label="Cancel" severity="secondary" [text]="true" (onClick)="showNotesDialog.set(false)" />
    <p-button
      label="Save Notes"
      icon="pi pi-check"
      severity="primary"
      [loading]="notesLoading()"
      (onClick)="saveNotes()"
    />
  </ng-template>
</p-dialog>
